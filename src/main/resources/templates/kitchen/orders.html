


<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Кухня - Поръчки</title>

  <!-- PWA Configuration -->
  <link rel="manifest" th:href="@{/manifest.json}">
  <meta name="theme-color" content="#1c2e30">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Borovo Oko">
  <link rel="apple-touch-icon" th:href="@{/images/logo.png}">

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            serif: ['"Cormorant Garamond"', 'serif'],
            sans: ['"Montserrat"', 'sans-serif'],
          },
          colors: {
            brand: {
              teal: '#67b0b6',
              gold: '#eab308',
              dark: '#1c2e30',
              light: '#fcfcfc',
              muted: '#94a3b8'
            }
          },
          animation: {
             'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
             'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
             'flash-green': 'flashGreen 4s ease-out forwards',
          },
          keyframes: {
            fadeInUp: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            },
            flashGreen: {
              '0%': { borderColor: '#67b0b6', boxShadow: '0 0 0 4px rgba(103, 176, 182, 0.3)' },
              '20%': { borderColor: '#67b0b6', boxShadow: '0 0 0 8px rgba(103, 176, 182, 0.5)' },
              '100%': { borderColor: '#e7e5e4', boxShadow: 'none' }
            }
          }
        }
      }
    }
  </script>
  <style>
    /* Custom Scrollbar for Light theme */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f5f5f4; }
    ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #a8a29e; }

    body { font-family: 'Montserrat', sans-serif; }
    h1, h2, h3, .font-serif { font-family: 'Cormorant Garamond', serif; }
  </style>
</head>
<body class="bg-stone-50 text-stone-800 min-h-screen flex flex-col">

<!-- Toast Container -->
<div id="toast-container" class="fixed top-24 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>

<!-- Header (Updated to match Admin Layout Design) -->
<header class="fixed top-0 left-0 right-0 z-50 transition-all duration-500 py-3 shadow-xl border-b border-white/10 bg-brand-dark/95 backdrop-blur-md">
  <div class="px-6 flex justify-between items-center">
    <div class="flex items-center gap-4">
      <div class="h-12 w-12 rounded-full border-2 border-brand-teal flex items-center justify-center bg-white overflow-hidden shadow-md">
        <span class="text-brand-dark font-serif font-bold text-xl">B</span>
      </div>
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-white leading-none tracking-wide">КУХНЯ</h1>
        <span class="text-[10px] uppercase tracking-[0.3em] text-brand-teal">Orders Dashboard</span>
      </div>
    </div>

    <div class="flex items-center gap-3 md:gap-6">

      <!-- Sound Toggle -->
      <button id="sound-toggle" onclick="toggleSound()" class="flex items-center gap-2 text-xs font-bold bg-stone-800 text-stone-400 border border-stone-600 px-4 py-2 rounded-full hover:bg-stone-700 transition-all cursor-pointer shadow-sm">
        <i class="fas fa-volume-mute text-lg"></i> <span class="hidden md:inline">Sound Off</span>
      </button>

      <!-- Connection Status -->
      <div id="connection-status" class="flex items-center gap-2 text-xs uppercase font-bold text-red-400 bg-red-500/10 px-4 py-2 rounded-full border border-red-500/20 transition-all duration-300">
        <span class="w-2 h-2 rounded-full bg-red-500"></span> <span class="hidden md:inline">Connecting...</span>
      </div>

      <form th:action="@{/logout}" method="post" class="hidden md:block">
        <button type="submit" class="flex items-center gap-2 text-stone-400 hover:text-white transition-colors text-sm font-medium uppercase tracking-wider">
          <i class="fas fa-sign-out-alt"></i> Exit
        </button>
      </form>
    </div>
  </div>
</header>

<!-- Main Content (Added pt-24 for fixed header) -->
<main class="flex-grow p-6 pt-24 overflow-y-auto bg-stone-50">

  <!-- Orders Grid -->
  <div id="orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">

    <!-- Existing Orders Loop -->
    <!-- data-timestamp formatted as 'yyyy-MM-dd HH:mm:ss' for reliable alphabetical sorting -->
    <div th:each="order : ${orders}"
         th:id="'order-' + ${order.id}"
         th:data-timestamp="${#temporals.format(order.orderDate, 'yyyy-MM-dd HH:mm:ss')}"
         class="group relative bg-white rounded-2xl overflow-hidden border border-stone-200 shadow-sm hover:shadow-xl transition-all duration-300 animate-fade-in-up flex flex-col">

      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-brand-teal to-brand-dark"></div>

      <!-- Card Header -->
      <div class="p-5 border-b border-stone-100 flex justify-between items-start bg-stone-50/80">
        <div>
          <div class="flex items-center gap-2 mb-1">
            <span class="text-3xl font-serif font-bold text-brand-dark">#<span th:text="${order.id}">123</span></span>
          </div>
          <div class="flex items-center gap-2 text-xs text-stone-500 font-medium uppercase tracking-wider">
            <i class="far fa-clock text-brand-teal"></i>
            <span th:text="${#temporals.format(order.orderDate, 'HH:mm')}">14:30</span>
          </div>
        </div>
        <div class="flex flex-col items-end">
                         <span class="inline-block px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-brand-teal text-white shadow-sm animate-pulse-slow">
                            <span th:text="${order.status}">PROCESSING</span>
                         </span>
        </div>
      </div>

      <!-- Card Body -->
      <div class="p-5 flex-grow space-y-4">
        <div class="flex items-start gap-3 text-sm text-stone-700 bg-stone-100 p-3 rounded-xl border border-stone-200/50">
          <i class="fas fa-map-marker-alt mt-1 text-brand-teal shrink-0"></i>
          <span class="leading-snug font-semibold" th:text="${order.location}">Location</span>
        </div>

        <ul class="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
          <li th:each="item : ${order.items}" class="flex justify-between items-start group/item p-2 rounded-lg hover:bg-stone-50 transition-colors">
            <div class="flex items-start gap-3 w-full">
                                <span class="flex items-center justify-center w-7 h-7 rounded-lg bg-brand-dark text-white font-bold text-sm shrink-0 shadow-sm"
                                      th:text="${item.quantity}">1</span>
              <span class="text-stone-800 font-medium leading-snug text-lg" th:text="${item.product.name}">Product</span>
            </div>
          </li>
        </ul>
      </div>

      <!-- Card Footer -->
      <div class="p-4 bg-stone-50 border-t border-stone-100 flex justify-between items-center text-sm mt-auto">
        <span class="text-xs text-stone-400 font-medium" th:text="${#temporals.format(order.orderDate, 'dd.MM.yyyy')}">Date</span>
        <span class="text-lg font-serif font-bold text-brand-dark" th:text="${#numbers.formatDecimal(order.totalPrice, 1, 2)} + ' лв.'">0.00 лв.</span>
      </div>
    </div>

  </div>

  <!-- Empty State -->
  <div th:if="${orders.isEmpty()}" id="empty-state" class="h-full flex flex-col items-center justify-center text-stone-600 min-h-[60vh] animate-fade-in-up">
    <div class="w-32 h-32 rounded-full bg-white flex items-center justify-center mb-6 shadow-xl border border-stone-100">
      <i class="fas fa-check text-5xl text-brand-teal"></i>
    </div>
    <h2 class="text-3xl font-serif font-bold text-brand-dark mb-2">Всичко е готово!</h2>
    <p class="text-stone-500">Няма чакащи поръчки в момента.</p>
  </div>

</main>

<script th:inline="javascript">
  // --- 1. Audio Logic ---
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  let audioCtx = new AudioContext();
  let isSoundEnabled = false;

  // Fix for browsers blocking audio: Unlock on first click anywhere
  document.addEventListener('click', function() {
      if (audioCtx.state === 'suspended') {
          audioCtx.resume();
      }
  }, { once: true });

  function toggleSound() {
      const btn = document.getElementById('sound-toggle');
      isSoundEnabled = !isSoundEnabled;

      if (isSoundEnabled) {
          if (audioCtx.state === 'suspended') audioCtx.resume();

          btn.className = "flex items-center gap-2 text-xs font-bold bg-brand-teal text-white border border-brand-teal px-4 py-2 rounded-full shadow-lg hover:bg-brand-teal/80 transition-all cursor-pointer";
          btn.innerHTML = '<i class="fas fa-volume-up text-lg"></i> <span class="hidden md:inline">Sound On</span>';

          // Play test sound
          playNotificationSound();
      } else {
          btn.className = "flex items-center gap-2 text-xs font-bold bg-stone-800 text-stone-400 border border-stone-600 px-4 py-2 rounded-full hover:bg-stone-700 transition-all cursor-pointer shadow-sm";
          btn.innerHTML = '<i class="fas fa-volume-mute text-lg"></i> <span class="hidden md:inline">Sound Off</span>';
      }
  }

  function playNotificationSound() {
      if (!isSoundEnabled) return;
      if (audioCtx.state === 'suspended') audioCtx.resume();

      const now = audioCtx.currentTime;

      // High Tone (Ding)
      const osc1 = audioCtx.createOscillator();
      const gain1 = audioCtx.createGain();
      osc1.connect(gain1);
      gain1.connect(audioCtx.destination);
      osc1.type = 'sine';
      osc1.frequency.setValueAtTime(880, now); // A5
      gain1.gain.setValueAtTime(0.5, now);
      gain1.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
      osc1.start(now);
      osc1.stop(now + 0.5);

      // Low Tone (Dong)
      const osc2 = audioCtx.createOscillator();
      const gain2 = audioCtx.createGain();
      osc2.connect(gain2);
      gain2.connect(audioCtx.destination);
      osc2.type = 'sine';
      osc2.frequency.setValueAtTime(698.46, now + 0.4); // F5
      gain2.gain.setValueAtTime(0.5, now + 0.4);
      gain2.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
      osc2.start(now + 0.4);
      osc2.stop(now + 1.5);
  }

  // --- 2. Sorting Logic (OLDEST FIRST / Ascending Date) ---
  function sortOrders() {
      const container = document.getElementById('orders-container');
      const cards = Array.from(container.querySelectorAll('div[id^="order-"]'));

      if (cards.length < 2) return;

      cards.sort((a, b) => {
          const timeA = a.getAttribute('data-timestamp') || '';
          const timeB = b.getAttribute('data-timestamp') || '';
          // Ascending order: Oldest at top
          return timeA.localeCompare(timeB);
      });

      // Re-append elements in new order
      cards.forEach(card => container.appendChild(card));
  }

  document.addEventListener('DOMContentLoaded', sortOrders);


  // --- 3. SSE Connection ---
  const sseUrl = [[@{/kitchen/stream}]];
  const eventSource = new EventSource(sseUrl);

  const ordersContainer = document.getElementById('orders-container');
  const emptyState = document.getElementById('empty-state');
  const statusIndicator = document.getElementById('connection-status');

  let isOptimisticallyLive = false;

  setTimeout(() => {
      if (eventSource.readyState !== 2) {
          updateStatus(true);
          isOptimisticallyLive = true;
      }
  }, 2500);

  setInterval(() => {
      if (eventSource.readyState === 1) {
          updateStatus(true);
          isOptimisticallyLive = true;
      } else if (eventSource.readyState === 2) {
          updateStatus(false);
          isOptimisticallyLive = false;
      } else if (eventSource.readyState === 0) {
          if (!isOptimisticallyLive) {
              updateStatus(false);
          }
      }
  }, 2000);

  eventSource.onopen = function() {
      console.log("SSE Connected");
      updateStatus(true);
      isOptimisticallyLive = true;
  };

  eventSource.onerror = function(event) {
      console.error("SSE Error", event);
      updateStatus(false);
      isOptimisticallyLive = false;
  };

  eventSource.onmessage = function(event) {
      handleIncomingOrder(event);
  };

  eventSource.addEventListener("order", function(event) {
      handleIncomingOrder(event);
  });

  eventSource.addEventListener("new-order", function(event) {
       handleIncomingOrder(event);
  });

  eventSource.addEventListener("create", function(event) {
       handleIncomingOrder(event);
  });

  function updateStatus(isLive) {
      if (isLive) {
          statusIndicator.className = "flex items-center gap-2 text-xs uppercase font-bold text-green-600 bg-green-50 px-4 py-2 rounded-full border border-green-200 transition-all duration-300 shadow-sm";
          statusIndicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> <span class="hidden md:inline">Live</span>';
      } else {
          statusIndicator.className = "flex items-center gap-2 text-xs uppercase font-bold text-red-500 bg-red-50 px-4 py-2 rounded-full border border-red-200 transition-all duration-300 shadow-sm";
          statusIndicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> <span class="hidden md:inline">Connecting...</span>';
      }
  }

  // --- 4. Handle New Orders ---
  function handleIncomingOrder(event) {
      updateStatus(true);
      isOptimisticallyLive = true;

      try {
          const order = JSON.parse(event.data);
          if (!order || !order.id) return;

          if (emptyState) emptyState.style.display = 'none';

          if(document.getElementById('order-' + order.id)) return;

          let itemsHtml = '';
          if (order.items && Array.isArray(order.items)) {
              order.items.forEach(item => {
                  let productName = item.product ? item.product.name : (item.productName || "Unknown");
                  let qty = item.quantity || 1;
                  itemsHtml += `
                      <li class="flex justify-between items-start group/item p-2 rounded-lg hover:bg-stone-50 transition-colors">
                          <div class="flex items-start gap-3 w-full">
                              <span class="flex items-center justify-center w-7 h-7 rounded-lg bg-brand-dark text-white font-bold text-sm shrink-0 shadow-sm">${qty}</span>
                              <span class="text-stone-800 font-medium leading-snug text-lg">${productName}</span>
                          </div>
                      </li>`;
              });
          }

          let dateObj = new Date();
          if (order.orderDate) {
              if (Array.isArray(order.orderDate)) {
                   dateObj = new Date(order.orderDate[0], order.orderDate[1]-1, order.orderDate[2], order.orderDate[3], order.orderDate[4], order.orderDate[5] || 0);
              } else {
                   dateObj = new Date(order.orderDate);
              }
          }

          const timeStr = dateObj.toLocaleTimeString('bg-BG', {hour: '2-digit', minute:'2-digit'});
          const dateStr = dateObj.toLocaleDateString('bg-BG');
          const priceStr = order.totalPrice ? Number(order.totalPrice).toFixed(2) : "0.00";

          const pad = (n) => n < 10 ? '0' + n : n;
          const sortableTimestamp =
              dateObj.getFullYear() + '-' +
              pad(dateObj.getMonth() + 1) + '-' +
              pad(dateObj.getDate()) + ' ' +
              pad(dateObj.getHours()) + ':' +
              pad(dateObj.getMinutes()) + ':' +
              pad(dateObj.getSeconds());

          const card = document.createElement('div');
          card.className = 'group relative bg-white rounded-2xl overflow-hidden border border-stone-200 shadow-sm hover:shadow-xl transition-all duration-300 animate-fade-in-up animate-flash-green flex flex-col';
          card.id = 'order-' + order.id;
          card.setAttribute('data-timestamp', sortableTimestamp);

          card.innerHTML = `
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-brand-teal to-brand-dark"></div>

              <div class="p-5 border-b border-stone-100 flex justify-between items-start bg-stone-50/80">
                  <div>
                      <div class="flex items-center gap-2 mb-1">
                          <span class="text-3xl font-serif font-bold text-brand-dark">#${order.id}</span>
                      </div>
                      <div class="flex items-center gap-2 text-xs text-stone-500 font-medium uppercase tracking-wider">
                          <i class="far fa-clock text-brand-teal"></i>
                          <span>${timeStr}</span>
                      </div>
                  </div>
                  <div class="flex flex-col items-end">
                       <span class="inline-block px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-brand-teal text-white shadow-sm animate-pulse-slow">
                          ${order.status || 'PROCESSING'}
                       </span>
                  </div>
              </div>

              <div class="p-5 flex-grow space-y-4">
                  <div class="flex items-start gap-3 text-sm text-stone-700 bg-stone-100 p-3 rounded-xl border border-stone-200/50">
                       <i class="fas fa-map-marker-alt mt-1 text-brand-teal shrink-0"></i>
                       <span class="leading-snug font-semibold">${order.location || 'Unknown'}</span>
                  </div>

                  <ul class="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                      ${itemsHtml}
                  </ul>
              </div>

              <div class="p-4 bg-stone-50 border-t border-stone-100 flex justify-between items-center text-sm mt-auto">
                   <span class="text-xs text-stone-400 font-medium">${dateStr}</span>
                   <span class="text-lg font-serif font-bold text-brand-dark">${priceStr} лв.</span>
              </div>
          `;

          ordersContainer.appendChild(card);

          setTimeout(() => {
              card.classList.remove('animate-flash-green');
          }, 5000);

          playNotificationSound();
          sortOrders();

      } catch (e) {
          console.error("Error parsing SSE data", e);
      }
  }
</script>
</body>
</html>