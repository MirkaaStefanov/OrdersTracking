
<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Кухня - Поръчки</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            serif: ['"Cormorant Garamond"', 'serif'],
            sans: ['"Montserrat"', 'sans-serif'],
          },
          colors: {
            brand: {
              teal: '#67b0b6',
              gold: '#eab308',
              dark: '#1c2e30',
              light: '#fcfcfc',
              muted: '#94a3b8'
            }
          },
          animation: {
             'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
             'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
             'flash-green': 'flashGreen 4s ease-out forwards',
          },
          keyframes: {
            fadeInUp: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            },
            flashGreen: {
              '0%': { borderColor: '#67b0b6', boxShadow: '0 0 0 4px rgba(103, 176, 182, 0.3)' },
              '20%': { borderColor: '#67b0b6', boxShadow: '0 0 0 8px rgba(103, 176, 182, 0.5)' },
              '100%': { borderColor: '#292524', boxShadow: 'none' }
            }
          }
        }
      }
    }
  </script>
  <style>
    /* Custom Scrollbar for dark theme */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1c1917; }
    ::-webkit-scrollbar-thumb { background: #44403c; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #57534e; }

    body { font-family: 'Montserrat', sans-serif; }
    h1, h2, h3, .font-serif { font-family: 'Cormorant Garamond', serif; }
  </style>
</head>
<body class="bg-stone-950 text-stone-200 min-h-screen flex flex-col">

<!-- Toast Container -->
<div id="toast-container" class="fixed top-24 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>

<!-- Header -->
<header class="bg-brand-dark border-b border-white/10 px-6 py-4 shadow-lg sticky top-0 z-50">
  <div class="flex justify-between items-center">
    <div class="flex items-center gap-4">
      <div class="h-12 w-12 rounded-full border-2 border-brand-teal flex items-center justify-center bg-white overflow-hidden">
        <span class="text-brand-dark font-serif font-bold text-xl">B</span>
      </div>
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-white leading-none tracking-wide">КУХНЯ</h1>
        <span class="text-[10px] uppercase tracking-[0.3em] text-brand-teal">Orders Dashboard</span>
      </div>
    </div>

    <div class="flex items-center gap-3 md:gap-6">

      <!-- Sound Toggle -->
      <button id="sound-toggle" onclick="toggleSound()" class="flex items-center gap-2 text-xs font-bold bg-stone-800 text-stone-400 border border-stone-700 px-4 py-2 rounded-full hover:bg-stone-700 transition-all cursor-pointer">
        <i class="fas fa-volume-mute text-lg"></i> <span class="hidden md:inline">Sound Off</span>
      </button>

      <!-- Connection Status -->
      <div id="connection-status" class="flex items-center gap-2 text-xs uppercase font-bold text-red-500 bg-red-500/10 px-4 py-2 rounded-full border border-red-500/30 transition-all duration-300">
        <span class="w-2 h-2 rounded-full bg-red-500"></span> <span class="hidden md:inline">Connecting...</span>
      </div>

      <form th:action="@{/logout}" method="post" class="hidden md:block">
        <button type="submit" class="flex items-center gap-2 text-stone-400 hover:text-white transition-colors text-sm font-medium uppercase tracking-wider">
          <i class="fas fa-sign-out-alt"></i> Exit
        </button>
      </form>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="flex-grow p-6 overflow-y-auto">

  <!-- Orders Grid -->
  <div id="orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">

    <!-- Existing Orders Loop -->
    <!-- data-timestamp formatted as 'yyyy-MM-dd HH:mm:ss' for reliable alphabetical sorting -->
    <div th:each="order : ${orders}"
         th:id="'order-' + ${order.id}"
         th:data-timestamp="${#temporals.format(order.orderDate, 'yyyy-MM-dd HH:mm:ss')}"
         class="group relative bg-stone-900 rounded-2xl overflow-hidden border border-stone-800 shadow-xl flex flex-col hover:border-brand-teal/50 transition-all duration-300 animate-fade-in-up">

      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-brand-teal to-brand-dark"></div>

      <div class="p-5 border-b border-stone-800 flex justify-between items-start bg-stone-900/50">
        <div>
          <div class="flex items-center gap-2 mb-1">
            <span class="text-2xl font-serif font-bold text-white">#<span th:text="${order.id}">123</span></span>
          </div>
          <div class="flex items-center gap-2 text-xs text-stone-400 font-medium uppercase tracking-wider">
            <i class="far fa-clock"></i>
            <span th:text="${#temporals.format(order.orderDate, 'HH:mm')}">14:30</span>
          </div>
        </div>
        <div class="flex flex-col items-end">
                         <span class="inline-block px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-brand-teal/10 text-brand-teal border border-brand-teal/20 animate-pulse-slow">
                            <span th:text="${order.status}">PROCESSING</span>
                         </span>
        </div>
      </div>

      <div class="p-5 flex-grow space-y-4">
        <div class="flex items-start gap-3 text-sm text-stone-300 bg-stone-800/50 p-3 rounded-lg">
          <i class="fas fa-map-marker-alt mt-1 text-brand-gold shrink-0"></i>
          <span class="leading-snug font-medium" th:text="${order.location}">Location</span>
        </div>

        <div class="w-full h-px bg-stone-800"></div>

        <ul class="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
          <li th:each="item : ${order.items}" class="flex justify-between items-start group/item">
            <div class="flex items-start gap-3">
                                <span class="flex items-center justify-center w-6 h-6 rounded-md bg-brand-teal/20 text-brand-teal font-bold text-sm shrink-0 border border-brand-teal/30"
                                      th:text="${item.quantity}">1</span>
              <span class="text-stone-200 font-medium leading-snug group-hover/item:text-white transition-colors" th:text="${item.product.name}">Product</span>
            </div>
          </li>
        </ul>
      </div>

      <div class="p-4 bg-stone-950/30 border-t border-stone-800 flex justify-between items-center">
        <span class="text-xs text-stone-500 font-mono" th:text="${#temporals.format(order.orderDate, 'dd.MM.yyyy')}">Date</span>
        <span class="text-sm font-serif font-bold text-stone-300" th:text="${#numbers.formatDecimal(order.totalPrice, 1, 2)} + ' лв.'">0.00 лв.</span>
      </div>
    </div>

  </div>

  <div th:if="${orders.isEmpty()}" id="empty-state" class="h-full flex flex-col items-center justify-center text-stone-600 min-h-[60vh]">
    <div class="w-32 h-32 rounded-full bg-stone-900 flex items-center justify-center mb-6 shadow-inner border border-stone-800">
      <i class="fas fa-check text-5xl text-stone-700"></i>
    </div>
    <h2 class="text-3xl font-serif font-bold text-stone-500 mb-2">Всичко е готово!</h2>
    <p class="text-stone-600">Няма чакащи поръчки в момента.</p>
  </div>

</main>

<script th:inline="javascript">
  // --- 1. Audio Logic ---
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  let audioCtx = new AudioContext();
  let isSoundEnabled = false;

  // Fix for browsers blocking audio: Unlock on first click anywhere
  document.addEventListener('click', function() {
      if (audioCtx.state === 'suspended') {
          audioCtx.resume();
      }
  }, { once: true });

  function toggleSound() {
      const btn = document.getElementById('sound-toggle');
      isSoundEnabled = !isSoundEnabled;

      if (isSoundEnabled) {
          if (audioCtx.state === 'suspended') audioCtx.resume();

          btn.className = "flex items-center gap-2 text-xs font-bold bg-brand-teal text-white border border-brand-teal px-4 py-2 rounded-full shadow-lg hover:bg-brand-teal/80 transition-all cursor-pointer";
          btn.innerHTML = '<i class="fas fa-volume-up text-lg"></i> <span class="hidden md:inline">Sound On</span>';

          // Play test sound
          playNotificationSound();
      } else {
          btn.className = "flex items-center gap-2 text-xs font-bold bg-stone-800 text-stone-400 border border-stone-700 px-4 py-2 rounded-full hover:bg-stone-700 transition-all cursor-pointer";
          btn.innerHTML = '<i class="fas fa-volume-mute text-lg"></i> <span class="hidden md:inline">Sound Off</span>';
      }
  }

  function playNotificationSound() {
      if (!isSoundEnabled) return;
      if (audioCtx.state === 'suspended') audioCtx.resume();

      const now = audioCtx.currentTime;

      // High Tone (Ding)
      const osc1 = audioCtx.createOscillator();
      const gain1 = audioCtx.createGain();
      osc1.connect(gain1);
      gain1.connect(audioCtx.destination);
      osc1.type = 'sine';
      osc1.frequency.setValueAtTime(880, now); // A5
      gain1.gain.setValueAtTime(0.5, now);
      gain1.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
      osc1.start(now);
      osc1.stop(now + 0.5);

      // Low Tone (Dong)
      const osc2 = audioCtx.createOscillator();
      const gain2 = audioCtx.createGain();
      osc2.connect(gain2);
      gain2.connect(audioCtx.destination);
      osc2.type = 'sine';
      osc2.frequency.setValueAtTime(698.46, now + 0.4); // F5
      gain2.gain.setValueAtTime(0.5, now + 0.4);
      gain2.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
      osc2.start(now + 0.4);
      osc2.stop(now + 1.5);
  }

  // --- 2. Sorting Logic (OLDEST FIRST / Ascending Date) ---
  function sortOrders() {
      const container = document.getElementById('orders-container');
      const cards = Array.from(container.querySelectorAll('div[id^="order-"]'));

      if (cards.length < 2) return;

      cards.sort((a, b) => {
          const timeA = a.getAttribute('data-timestamp') || '';
          const timeB = b.getAttribute('data-timestamp') || '';
          // Ascending order: Oldest at top
          return timeA.localeCompare(timeB);
      });

      // Re-append elements in new order
      // Note: Using appendChild moves the existing DOM element, it does not recreate it.
      // This preserves selection but might restart CSS animations if logic isn't careful.
      cards.forEach(card => container.appendChild(card));
  }

  document.addEventListener('DOMContentLoaded', sortOrders);


  // --- 3. SSE Connection ---
  const sseUrl = [[@{/kitchen/stream}]];
  const eventSource = new EventSource(sseUrl);

  const ordersContainer = document.getElementById('orders-container');
  const emptyState = document.getElementById('empty-state');
  const statusIndicator = document.getElementById('connection-status');

  let isOptimisticallyLive = false;

  // Optimistic Connection Logic:
  // If headers are buffered by proxy, readyState might stay 0 (Connecting).
  // If no error occurs within 2.5 seconds, assume we are essentially live to improve UX.
  setTimeout(() => {
      if (eventSource.readyState !== 2) { // If not closed/error
          updateStatus(true);
          isOptimisticallyLive = true;
      }
  }, 2500);

  // Monitor Connection State Periodically
  setInterval(() => {
      if (eventSource.readyState === 1) {
          // 1 = OPEN
          updateStatus(true);
          isOptimisticallyLive = true;
      } else if (eventSource.readyState === 2) {
          // 2 = CLOSED
          updateStatus(false);
          isOptimisticallyLive = false;
      } else if (eventSource.readyState === 0) {
          // 0 = CONNECTING
          // Only show "Connecting" if we haven't already decided we are optimistically live
          if (!isOptimisticallyLive) {
              updateStatus(false);
          }
      }
  }, 2000);

  eventSource.onopen = function() {
      console.log("SSE Connected");
      updateStatus(true);
      isOptimisticallyLive = true;
  };

  eventSource.onerror = function(event) {
      console.error("SSE Error", event);
      updateStatus(false);
      isOptimisticallyLive = false;
  };

  // Handle Unnamed Events (Default)
  eventSource.onmessage = function(event) {
      handleIncomingOrder(event);
  };

  // Handle Named Events (Common in Spring Boot SSE)
  eventSource.addEventListener("order", function(event) {
      handleIncomingOrder(event);
  });

  eventSource.addEventListener("new-order", function(event) {
       handleIncomingOrder(event);
  });

  eventSource.addEventListener("create", function(event) {
       handleIncomingOrder(event);
  });

  function updateStatus(isLive) {
      if (isLive) {
          statusIndicator.className = "flex items-center gap-2 text-xs uppercase font-bold text-green-500 bg-green-500/10 px-4 py-2 rounded-full border border-green-500/30 transition-all duration-300";
          statusIndicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> <span class="hidden md:inline">Live</span>';
      } else {
          statusIndicator.className = "flex items-center gap-2 text-xs uppercase font-bold text-red-500 bg-red-500/10 px-4 py-2 rounded-full border border-red-500/30 transition-all duration-300";
          statusIndicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> <span class="hidden md:inline">Connecting...</span>';
      }
  }

  // --- 4. Handle New Orders ---
  function handleIncomingOrder(event) {
      // Fail-safe: If we get data, we are definitely live
      updateStatus(true);
      isOptimisticallyLive = true;

      try {
          const order = JSON.parse(event.data);
          if (!order || !order.id) return;

          if (emptyState) emptyState.style.display = 'none';

          // Deduplicate
          if(document.getElementById('order-' + order.id)) return;

          // Render Items
          let itemsHtml = '';
          if (order.items && Array.isArray(order.items)) {
              order.items.forEach(item => {
                  let productName = item.product ? item.product.name : (item.productName || "Unknown");
                  let qty = item.quantity || 1;
                  itemsHtml += `
                      <li class="flex justify-between items-start group/item">
                          <div class="flex items-start gap-3">
                              <span class="flex items-center justify-center w-6 h-6 rounded-md bg-brand-teal/20 text-brand-teal font-bold text-sm shrink-0 border border-brand-teal/30">${qty}</span>
                              <span class="text-stone-200 font-medium leading-snug group-hover/item:text-white transition-colors">${productName}</span>
                          </div>
                      </li>`;
              });
          }

          // Format Date
          let dateObj = new Date();
          if (order.orderDate) {
              if (Array.isArray(order.orderDate)) {
                   dateObj = new Date(order.orderDate[0], order.orderDate[1]-1, order.orderDate[2], order.orderDate[3], order.orderDate[4], order.orderDate[5] || 0);
              } else {
                   dateObj = new Date(order.orderDate);
              }
          }

          const timeStr = dateObj.toLocaleTimeString('bg-BG', {hour: '2-digit', minute:'2-digit'});
          const dateStr = dateObj.toLocaleDateString('bg-BG');
          const priceStr = order.totalPrice ? Number(order.totalPrice).toFixed(2) : "0.00";

          const pad = (n) => n < 10 ? '0' + n : n;
          const sortableTimestamp =
              dateObj.getFullYear() + '-' +
              pad(dateObj.getMonth() + 1) + '-' +
              pad(dateObj.getDate()) + ' ' +
              pad(dateObj.getHours()) + ':' +
              pad(dateObj.getMinutes()) + ':' +
              pad(dateObj.getSeconds());

          const card = document.createElement('div');
          // HIGHLIGHT: 'animate-flash-green' added ONLY to new cards
          card.className = 'group relative bg-stone-900 rounded-2xl overflow-hidden border border-stone-800 shadow-xl flex flex-col hover:border-brand-teal/50 transition-all duration-300 animate-fade-in-up animate-flash-green';
          card.id = 'order-' + order.id;
          card.setAttribute('data-timestamp', sortableTimestamp);

          card.innerHTML = `
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-brand-teal to-brand-dark"></div>

              <div class="p-5 border-b border-stone-800 flex justify-between items-start bg-stone-900/50">
                  <div>
                      <div class="flex items-center gap-2 mb-1">
                          <span class="text-2xl font-serif font-bold text-white">#${order.id}</span>
                      </div>
                      <div class="flex items-center gap-2 text-xs text-stone-400 font-medium uppercase tracking-wider">
                          <i class="far fa-clock"></i>
                          <span>${timeStr}</span>
                      </div>
                  </div>
                  <div class="flex flex-col items-end">
                       <span class="inline-block px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-brand-teal/10 text-brand-teal border border-brand-teal/20 animate-pulse-slow">
                          ${order.status || 'PROCESSING'}
                       </span>
                  </div>
              </div>

              <div class="p-5 flex-grow space-y-4">
                  <div class="flex items-start gap-3 text-sm text-stone-300 bg-stone-800/50 p-3 rounded-lg">
                       <i class="fas fa-map-marker-alt mt-1 text-brand-gold shrink-0"></i>
                       <span class="leading-snug font-medium">${order.location || 'Unknown'}</span>
                  </div>

                  <div class="w-full h-px bg-stone-800"></div>

                  <ul class="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                      ${itemsHtml}
                  </ul>
              </div>

              <div class="p-4 bg-stone-950/30 border-t border-stone-800 flex justify-between items-center">
                   <span class="text-xs text-stone-500 font-mono">${dateStr}</span>
                   <span class="text-sm font-serif font-bold text-stone-300">${priceStr} лв.</span>
              </div>
          `;

          // Append to container
          ordersContainer.appendChild(card);

          // Remove the flash class after 5 seconds to ensure only "new" ones look active
          setTimeout(() => {
              card.classList.remove('animate-flash-green');
          }, 5000);

          // PLAY SOUND
          playNotificationSound();

          // Re-sort
          sortOrders();

      } catch (e) {
          console.error("Error parsing SSE data", e);
      }
  }
</script>
</body>
</html>
