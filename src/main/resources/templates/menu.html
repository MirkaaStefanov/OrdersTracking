

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/public-layout}">
<head>
    <title>Меню - Борово Око</title>
</head>
<body>

<div layout:fragment="content">

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-24 right-4 z-[100] flex flex-col gap-2 pointer-events-none">
        <!-- Toasts will be injected here via JS -->
    </div>

    <!-- 1. HERO SECTION -->
    <section id="home" class="relative h-screen w-full overflow-hidden flex items-center justify-center">
        <div class="absolute inset-0 z-0">
            <img th:src="@{/images/Görüntü.jpg}"
                 src="https://images.unsplash.com/photo-1499553232714-16d73f554646?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80"
                 alt="Background"
                 class="w-full h-full object-cover animate-scale-slow"
                 onerror="this.src='https://images.unsplash.com/photo-1499553232714-16d73f554646?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80'" />
            <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/30 to-brand-dark/90"></div>
        </div>

        <div class="relative z-10 text-center text-white px-4 animate-fade-in-up max-w-4xl mx-auto">
            <div class="flex items-center justify-center gap-4 mb-6 opacity-0 animate-fade-in" style="animation-delay: 0.2s">
                <div class="h-[1px] w-12 bg-brand-teal"></div>
                <span class="text-sm md:text-base tracking-[0.3em] uppercase text-brand-teal font-medium">
                  Est. 2008
                </span>
                <div class="h-[1px] w-12 bg-brand-teal"></div>
            </div>

            <h1 class="text-5xl md:text-7xl lg:text-9xl font-serif font-bold mb-8 leading-tight drop-shadow-2xl">
                РЕСТОРАНТ<br />
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-light via-brand-teal to-brand-light bg-300% animate-shimmer">
                  БОРОВО ОКО
                </span>
            </h1>

            <p class="max-w-2xl mx-auto text-lg md:text-2xl text-gray-100 font-light mb-12 leading-relaxed opacity-0 animate-fade-in-up" style="animation-delay: 0.4s">
                Където изисканите вкусове срещат спокойствието на езерото.
                <br/>Кулинарно пътешествие в сърцето на природата.
            </p>

            <div class="flex flex-col sm:flex-row gap-6 justify-center opacity-0 animate-fade-in-up" style="animation-delay: 0.6s">
                <button onclick="document.getElementById('menu-section').scrollIntoView({ behavior: 'smooth' })"
                        class="bg-brand-teal text-white px-10 py-4 rounded-full font-semibold tracking-wide hover:bg-brand-light hover:text-brand-dark transition-all duration-300 shadow-[0_0_20px_rgba(103,176,182,0.5)] transform hover:-translate-y-1">
                    Виж Менюто
                </button>

                <button onclick="document.getElementById('reservation').scrollIntoView({ behavior: 'smooth' })"
                        class="group relative overflow-hidden px-10 py-4 rounded-full font-semibold tracking-wide text-white border border-white/30 backdrop-blur-sm transition-all duration-300 hover:border-white/60">
                    <span class="relative z-10">Резервирай Маса</span>
                    <div class="absolute inset-0 bg-white/10 transform -translate-x-full group-hover:translate-x-0 transition-transform duration-500"></div>
                </button>
            </div>
        </div>

        <div onclick="document.getElementById('menu-section').scrollIntoView({ behavior: 'smooth' })"
             class="absolute bottom-10 left-1/2 transform -translate-x-1/2 cursor-pointer animate-bounce hover:text-brand-teal transition-colors z-20">
            <i class="fas fa-chevron-down text-white/70 text-4xl"></i>
        </div>
    </section>

    <!-- 2. MENU SECTION (MOVED UP) -->
    <section id="menu-section" class="py-24 bg-stone-50 relative overflow-hidden min-h-screen">

        <div class="absolute top-0 left-0 w-[500px] h-[500px] bg-brand-teal/5 rounded-full blur-[100px] -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
        <div class="absolute bottom-0 right-0 w-[600px] h-[600px] bg-brand-gold/5 rounded-full blur-[100px] translate-x-1/2 translate-y-1/2 pointer-events-none"></div>

        <div class="container mx-auto px-4 relative z-10">

            <div class="text-center mb-16">
                <div class="flex items-center justify-center gap-3 mb-4">
                    <div class="h-[1px] w-8 bg-brand-gold"></div>
                    <h3 class="text-brand-teal font-medium tracking-widest uppercase text-sm">Culinary Delights</h3>
                    <div class="h-[1px] w-8 bg-brand-gold"></div>
                </div>
                <h2 class="text-4xl md:text-6xl font-serif font-bold text-brand-dark mb-6">Нашето Ежедневно Меню</h2>
                <p class="mt-4 text-stone-500 max-w-2xl mx-auto italic font-light text-lg">
                    "Пресни местни съставки, традиционни рецепти предавани през поколенията и модерен прочит за ценители."
                </p>
            </div>

            <!-- Dynamic Filter Buttons -->
            <div class="flex flex-wrap justify-center gap-3 mb-14" id="category-buttons">
                <!-- 'All' Button -->
                <button onclick="filterMenu('all', this)"
                        class="category-btn active px-8 py-3 rounded-full font-medium transition-all duration-300 relative overflow-hidden bg-brand-dark text-white shadow-lg scale-105 ring-2 ring-brand-teal ring-offset-2">
                    Всички
                </button>

                <!-- Category Loop -->
                <button th:each="cat : ${categories}"
                        th:data-category="${cat}"
                        onclick="filterMenu(this.getAttribute('data-category'), this)"
                        th:text="${cat.displayName}"
                        class="category-btn px-8 py-3 rounded-full font-medium transition-all duration-300 relative overflow-hidden bg-white text-stone-600 hover:bg-stone-100">
                    Category Name
                </button>
            </div>

            <div th:if="${menu == null or menu.isEmpty()}" class="text-center py-20">
                <div class="inline-block p-6 rounded-full bg-stone-100 mb-4 text-brand-muted">
                    <i class="fas fa-utensils text-4xl"></i>
                </div>
                <h2 class="text-2xl font-serif font-bold text-stone-600 mb-2">В момента няма налични продукти</h2>
                <p class="text-stone-400">Моля, опитайте отново по-късно.</p>
            </div>

            <div id="menu-grid" th:unless="${menu == null or menu.isEmpty()}" class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-6 max-w-6xl mx-auto items-start">

                <div th:each="product : ${menu}"
                     class="menu-item group relative bg-white p-6 rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 border border-stone-100 flex justify-between items-start gap-5"
                     th:attr="data-category=${product.category}">

                    <div class="absolute top-0 left-0 w-1.5 h-0 bg-brand-teal group-hover:h-full transition-all duration-300 rounded-l-2xl"></div>

                    <div class="flex-grow">
                        <div class="flex justify-between items-baseline mb-2">
                            <h3 class="text-xl md:text-2xl font-serif font-bold text-brand-dark group-hover:text-brand-teal transition-colors" th:text="${product.name}">
                                Име на продукт
                            </h3>
                            <div class="flex gap-2 ml-2" th:if="${#strings.containsIgnoreCase(product.description, 'без месо') or #strings.containsIgnoreCase(product.description, 'сирене') or #strings.containsIgnoreCase(product.description, 'спанак')}">
                                <i class="fas fa-leaf text-green-500 text-sm"></i>
                            </div>
                        </div>

                        <div class="w-full border-b border-dotted border-stone-300 mb-3 opacity-30"></div>

                        <p class="text-stone-500 text-sm font-light leading-relaxed mb-3" th:text="${product.description}">
                            Описание на продукта...
                        </p>

                        <div class="flex gap-2 mt-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300 transform translate-y-2 group-hover:translate-y-0">
                            <!-- Tags based on category or description -->
                            <span th:if="${product.category != null}"
                                  th:text="${product.category.displayName}"
                                  class="text-xs uppercase tracking-wider font-bold text-brand-teal bg-teal-50 px-2 py-0.5 rounded">
                                   Cat
                             </span>
                            <span class="text-xs uppercase tracking-wider font-bold text-brand-gold bg-amber-50 px-2 py-0.5 rounded">Special</span>
                        </div>
                    </div>

                    <div class="flex flex-col items-end shrink-0 min-w-[100px]">
                        <span class="text-2xl font-serif font-bold text-brand-dark group-hover:scale-105 transition-transform duration-300" th:text="${#numbers.formatDecimal(product.price, 1, 2)} + ' лв.'">
                            9.90 лв.
                        </span>
                        <span class="text-xs text-stone-400 font-medium mt-1" th:text="${#numbers.formatDecimal(product.euroPrice, 1, 2)} + ' €'">
                            5.01 €
                        </span>

                        <!-- Dynamic AJAX Form -->
                        <form th:action="@{/cart/add/{id}(id=${product.id})}" method="post" class="mt-3 add-to-cart-form" onsubmit="addToCart(event, this)">
                            <input type="hidden" name="quantity" value="1" />
                            <button type="submit"
                                    class="w-10 h-10 rounded-full bg-stone-100 text-brand-dark flex items-center justify-center transition-all hover:bg-brand-teal hover:text-white hover:scale-110 shadow-md"
                                    title="Добави">
                                <i class="fas fa-plus text-sm"></i>
                            </button>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <!-- 3. ABOUT SECTION (MOVED DOWN) -->
    <section id="about" class="py-24 bg-brand-dark text-white relative overflow-hidden">
        <div class="absolute inset-0 opacity-5" style="background-image: radial-gradient(#67b0b6 1px, transparent 1px); background-size: 30px 30px;"></div>

        <div class="container mx-auto px-6 relative z-10">
            <div class="flex flex-col lg:flex-row items-center gap-16">

                <div class="lg:w-1/2 order-2 lg:order-1">
                    <div class="inline-block border border-brand-teal/30 px-4 py-1 rounded-full mb-6">
                        <span class="text-brand-teal text-xs uppercase tracking-widest font-bold">Локация</span>
                    </div>
                    <h2 class="text-4xl md:text-6xl font-serif font-bold mb-8 leading-tight">
                        Вечеря край <br/>
                        <span class="italic text-brand-teal">Езерото</span>
                    </h2>
                    <p class="text-gray-300 leading-loose mb-6 text-lg font-light">
                        Сгушен в сърцето на природата, <strong class="text-white font-medium">Ресторант Борово Око</strong> предлага убежище от градския шум.
                        Нашата философия е да съчетаем изисканата храна със спокойствието на заобикалящата среда.
                    </p>
                    <p class="text-gray-400 leading-loose mb-10">
                        Независимо дали се наслаждавате на нашата "Есенна салата" на терасата или се сгрявате с топла супа в уютния ни интериор,
                        всеки момент е създаден, за да се помни. Ние използваме местни продукти, за да донесем автентичния вкус на региона във вашата чиния.
                    </p>

                    <div class="grid grid-cols-3 gap-8 border-t border-white/10 pt-8">
                        <div class="text-center lg:text-left">
                            <span class="block text-4xl font-serif font-bold text-brand-gold mb-1">15+</span>
                            <span class="text-xs uppercase tracking-widest text-gray-500">Години</span>
                        </div>
                        <div class="text-center lg:text-left">
                            <span class="block text-4xl font-serif font-bold text-brand-gold mb-1">100%</span>
                            <span class="text-xs uppercase tracking-widest text-gray-500">Прясна Храна</span>
                        </div>
                        <div class="text-center lg:text-left">
                            <span class="block text-4xl font-serif font-bold text-brand-gold mb-1">4.9</span>
                            <span class="text-xs uppercase tracking-widest text-gray-500">Рейтинг</span>
                        </div>
                    </div>
                </div>

                <div class="lg:w-1/2 relative order-1 lg:order-2">
                    <div class="relative z-10 grid grid-cols-2 gap-4">
                        <div class="relative group overflow-hidden rounded-2xl shadow-2xl translate-y-8">
                            <div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-colors duration-500 z-10"></div>
                            <img src="https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80"
                                 alt="Restaurant Interior"
                                 class="object-cover h-72 w-full transform group-hover:scale-110 transition-transform duration-700" />
                        </div>

                        <div class="relative group overflow-hidden rounded-2xl shadow-2xl">
                            <div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-colors duration-500 z-10"></div>
                            <img src="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?ixlib=rb-4.0.3&auto=format&fit=crop&w=1160&q=80"
                                 alt="Fresh Salad Plated"
                                 class="object-cover h-72 w-full transform group-hover:scale-110 transition-transform duration-700" />
                        </div>
                    </div>

                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[130%] h-[130%] border border-white/5 rounded-full -z-0 animate-spin-slow pointer-events-none"></div>
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] h-[90%] border border-white/5 rounded-full -z-0 animate-spin-slow pointer-events-none" style="animation-direction: reverse;"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- 4. RESERVATION SECTION -->
    <section id="reservation" class="py-24 bg-stone-100 relative">
        <div class="container mx-auto px-6">
            <div class="flex flex-col lg:flex-row gap-16 items-center">
                <div class="lg:w-1/2 space-y-8">
                    <h2 class="text-4xl md:text-5xl font-serif font-bold text-brand-dark">Резервирайте <br/><span class="text-brand-teal italic">Маса</span></h2>
                    <p class="text-stone-600 text-lg leading-relaxed">
                        Планирате специална вечеря или просто искате да се насладите на хубава храна с приятели?
                        Обадете ни се или попълнете формата за резервация.
                    </p>
                    <div class="flex items-center gap-4 text-brand-dark font-medium">
                        <div class="w-12 h-12 rounded-full bg-brand-teal text-white flex items-center justify-center text-xl">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <span class="text-xl">+359 89 123 4567</span>
                    </div>
                </div>

                <div class="lg:w-1/2 bg-white p-10 rounded-3xl shadow-xl w-full relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-brand-teal"></div>
                    <form>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-xs uppercase tracking-widest text-stone-500 mb-2 font-semibold">Име</label>
                                <div class="relative">
                                    <i class="fas fa-user absolute left-4 top-1/2 transform -translate-y-1/2 text-stone-400"></i>
                                    <input type="text" class="w-full bg-stone-50 border border-stone-200 rounded-lg pl-10 pr-4 py-3 focus:outline-none focus:border-brand-teal transition-colors" placeholder="Вашето име">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs uppercase tracking-widest text-stone-500 mb-2 font-semibold">Телефон</label>
                                <div class="relative">
                                    <i class="fas fa-phone absolute left-4 top-1/2 transform -translate-y-1/2 text-stone-400"></i>
                                    <input type="tel" class="w-full bg-stone-50 border border-stone-200 rounded-lg pl-10 pr-4 py-3 focus:outline-none focus:border-brand-teal transition-colors" placeholder="088...">
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div>
                                <label class="block text-xs uppercase tracking-widest text-stone-500 mb-2 font-semibold">Дата</label>
                                <input type="date" class="w-full bg-stone-50 border border-stone-200 rounded-lg px-4 py-3 focus:outline-none focus:border-brand-teal transition-colors text-stone-600">
                            </div>
                            <div>
                                <label class="block text-xs uppercase tracking-widest text-stone-500 mb-2 font-semibold">Час</label>
                                <div class="relative">
                                    <i class="far fa-clock absolute left-4 top-1/2 transform -translate-y-1/2 text-stone-400"></i>
                                    <select class="w-full bg-stone-50 border border-stone-200 rounded-lg pl-10 pr-4 py-3 focus:outline-none focus:border-brand-teal transition-colors appearance-none text-stone-600">
                                        <option>18:00</option>
                                        <option>19:00</option>
                                        <option>20:00</option>
                                        <option>21:00</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs uppercase tracking-widest text-stone-500 mb-2 font-semibold">Гости</label>
                                <div class="relative">
                                    <i class="fas fa-user-friends absolute left-4 top-1/2 transform -translate-y-1/2 text-stone-400"></i>
                                    <select class="w-full bg-stone-50 border border-stone-200 rounded-lg pl-10 pr-4 py-3 focus:outline-none focus:border-brand-teal transition-colors appearance-none text-stone-600">
                                        <option>2</option>
                                        <option>3</option>
                                        <option>4</option>
                                        <option>5+</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-brand-dark text-white font-bold py-4 rounded-lg hover:bg-brand-teal transition-colors shadow-lg transform hover:-translate-y-1">
                            Потвърди Резервация
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <section class="py-20 bg-brand-teal text-white text-center relative overflow-hidden">
        <div class="absolute inset-0 bg-black/10"></div>
        <div class="container mx-auto px-4 relative z-10">
            <h2 class="text-3xl md:text-4xl font-serif font-bold mb-6">Организирайте Вашето Събитие При Нас</h2>
            <p class="max-w-2xl mx-auto mb-8 text-lg opacity-90 font-light">
                От сватби до фирмени събирания, гледката към езерото предоставя перфектния фон за незабравими моменти.
            </p>
            <a href="#contact" class="inline-block bg-white text-brand-teal px-8 py-3 rounded-full font-bold hover:bg-brand-gold hover:text-white transition-colors shadow-lg">
                Запитайте Сега
            </a>
        </div>
    </section>

    <!-- Script for Category Filtering AND Dynamic Cart -->
    <script>
        // 1. Category Filtering Logic
        function filterMenu(category, btnElement) {
            // Update visual state of buttons
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(btn => {
                btn.classList.remove('bg-brand-dark', 'text-white', 'shadow-lg', 'scale-105', 'ring-2', 'ring-brand-teal', 'ring-offset-2', 'active');
                btn.classList.add('bg-white', 'text-stone-600', 'hover:bg-stone-100');
            });

            if(btnElement) {
                btnElement.classList.remove('bg-white', 'text-stone-600', 'hover:bg-stone-100');
                btnElement.classList.add('bg-brand-dark', 'text-white', 'shadow-lg', 'scale-105', 'ring-2', 'ring-brand-teal', 'ring-offset-2', 'active');
            }

            // Filter Items
            const items = document.querySelectorAll('.menu-item');
            items.forEach(item => {
                const itemCategory = item.getAttribute('data-category');

                let show = false;
                if (category === 'all') {
                    show = true;
                } else if (itemCategory === category) {
                    show = true;
                }

                if (show) {
                    item.style.display = 'flex';
                    // Reset animation to play it again
                    item.style.animation = 'none';
                    item.offsetHeight; /* trigger reflow */
                    item.style.animation = 'fadeInUp 0.5s ease-out forwards';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // 2. Dynamic Add To Cart Logic
        async function addToCart(event, formElement) {
            event.preventDefault();

            const url = formElement.action;
            const btn = formElement.querySelector('button');
            const originalIcon = btn.innerHTML;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const formData = new FormData(formElement);
                const params = new URLSearchParams(formData);

                // IMPORTANT: Use redirect: 'manual' to prevent the browser from following
                // the redirect to 'localhost' (which causes connection errors behind ngrok/proxies).
                // We rely on response.type === 'opaqueredirect' or status 302 as success.
                const response = await fetch(url, {
                    method: 'POST',
                    body: params,
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    redirect: 'manual'
                });

                // Check for success (Redirect or OK)
                if (response.ok || response.type === 'opaqueredirect' || response.status === 302) {
                    showToast('Продуктът е добавен успешно!');
                    updateCartBadgeCount();
                } else {
                    showToast('Възникна грешка. Моля опитайте отново.', true);
                    console.error('Cart add failed with status:', response.status);
                }

            } catch (error) {
                console.error('Error adding to cart:', error);
                showToast('Грешка при връзката със сървъра.', true);
            } finally {
                btn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    btn.innerHTML = originalIcon;
                    btn.disabled = false;
                }, 1500);
            }
        }

        // Helper: Increment Badge Count Visuals
        function updateCartBadgeCount() {
            const badges = document.querySelectorAll('.cart-count-badge');

            badges.forEach(badge => {
                // Remove hidden class first
                badge.classList.remove('hidden');

                // Use textContent for safer access, trim whitespace
                let text = badge.textContent ? badge.textContent.trim() : '0';
                let count = parseInt(text);

                // If it was empty or not a number, start at 0
                if (isNaN(count)) count = 0;

                badge.textContent = count + 1;

                badge.classList.add('scale-125');
                setTimeout(() => badge.classList.remove('scale-125'), 200);
            });
        }

        // Helper: Show Toast Notification
        function showToast(message, isError = false) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            toast.className = `pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg text-white transform transition-all duration-500 translate-x-full opacity-0 ${
                isError ? 'bg-red-500' : 'bg-brand-dark border-l-4 border-brand-teal'
            }`;

            toast.innerHTML = `
                <i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
                <span class="text-sm font-medium">${message}</span>
            `;

            container.appendChild(toast);

            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            });

            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
             const items = document.querySelectorAll('.menu-item');
             items.forEach((item, index) => {
                 item.style.animationDelay = (index * 0.1) + 's';
             });
        });
    </script>

</div>
</body>
</html>